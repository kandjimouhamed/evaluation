<?php 
include('header.php');
$reponse1 = $bdd->query('SELECT * FROM filiale ORDER BY filialenom ASC');
$reponse2 = $bdd->query('SELECT * FROM direction ORDER BY directionnom ASC');
$reponse3 = $bdd->query('SELECT * FROM clients ORDER BY nom ASC');
$reponse4 = $bdd->query('SELECT * FROM vehicules ORDER BY immatriculation ASC');
$reponse5 = $bdd->query('SELECT * FROM etat');

if ($_SESSION['profil'] == 1)
{
    $req = $bdd->prepare('SELECT * FROM `dossier` ORDER BY datedebut DESC LIMIT 15');
    $req->execute();
}
else 
{
    
    $req = $bdd->prepare('SELECT * FROM `dossier` WHERE directioncode IN (SELECT directioncode FROM direction WHERE filialecode = ?) ORDER BY datedebut DESC LIMIT 15');
    $req->execute(array($_SESSION['filialecode']));
}

?>

<div id="content">
  <div id="content-header">
    <div id="breadcrumb"> <a href="index.php" title="Retour" class="tip-bottom"><i class="glyphicon glyphicon-home"></i> Accueil</a> <a href="#" class="current"><i class="glyphicon glyphicon-dashboard"></i>Tableau de bord</a></div>
  </div>
  <div class="container-fluid">
	   <div class="row-fluid">
      <div class="span6">
        <div class="widget-box">
	  <fieldset class="scheduler-border">
    <legend class="scheduler-border">Filtrer</legend>
    <div class="control-group">
        <label class="control-label input-label" for="startTime">Filiale</label>
        <div class="controls bootstrap-timepicker">
            <select class="span12" name="filiale">
		 <option></option>
  <?php 
                                     while ($donnees = $reponse1->fetch())
                                     {
                                         if ($donnees['filialecode'] == $filiale)
                                         {echo '<option value="'.$donnees['filialecode'].'" selected>'.$donnees['filialenom'].'</option>'; }
                                         else
                                         { echo '<option value="'.$donnees['filialecode'].'">'.$donnees['filialenom'].'</option>'; }
                                     }
                         ?>             
</select> 
        </div>
    </div>
    <div class="control-group">
        <label class="control-label input-label" for="startTime">Direction</label>
        <div class="controls bootstrap-timepicker">
           <select class="span12" name="direction">
		 <option></option>
  <?php 
                                     while ($donnees = $reponse2->fetch())
                                     {
                                         if ($donnees['directioncode'] == $direction)
                                         {echo '<option value="'.$donnees['directioncode'].'" selected>'.$donnees['directionnom'].'</option>'; }
                                         else
                                         {echo '<option value="'.$donnees['directioncode'].'">'.$donnees['directionnom'].'</option>'; }
                                     }
                         ?>             
</select> 
        </div>
    </div>
    <div class="control-group">
        <label class="control-label input-label" for="startTime">Client</label>
        <div class="controls bootstrap-timepicker">
            <select class="span12" name="client">
		 <option></option>
  <?php 
                                     while ($donnees = $reponse3->fetch())
                                     {
                                         if ($donnees['IDCLIENT'] == $client)
                                         {echo '<option value="'.$donnees['IDCLIENT'].'" selected>'.$donnees['nom'].'</option>'; }
                                         else
                                         {echo '<option value="'.$donnees['IDCLIENT'].'">'.$donnees['nom'].'</option>'; }
                                     }
                         ?>             
</select> 
</div>

<div class="form-actions"><br/><br/>
 <input class="w3-btn w3-blue" type="reset" name="effacer" value="Reinitialiser"> 
<input class="w3-btn w3-blue" type="submit" name="valider" value="Valider"> 
               
</div>

    </div>
</fieldset>
 </div>
 </div>
 </div>

 <div class="row-fluid">
<div class="span12">
        <div class="widget-box">
          <div class="widget-title">
             <span class="icon"><i class="icon-th"></i></span> 
            <h5>Liste des OR</h5>     
          </div>
          <div class="widget-content nopadding" style="overflow: scroll;">
         <?php /*if (!isset($_GET['page']))
    {
        echo '<a href="ajouter_dossier.php"> <button class="btn btn-primary">Ajouter</button></a>';
    } */?>
           
            <table class="data-table table ">
              <thead>
                <tr>
                  <th style="width:5%;">#</th>
                  <th>OR</th>
                  <th>Devis</th>
                  <th>Kilometrage</th>
                  <th>Client</th>
                  <th>Vehicule</th>
                  <th>Objet OR</th>
                  <th>Debut</th>
                  <th>Fin</th>
                  <th>Action</th>
                  <th>Ressource</th>
                 
                 
                </tr>
              </thead>
              <tbody>
              <?php 
              $i =1;
              while ($donnees = $req->fetch())
              {
                  $client = getClient($donnees['dossiercode'],$bdd);
                  $vehicule = getVehicule($donnees['dossiercode'],$bdd);
                  $intervenantActuel = getIntervenantActuel($donnees['dossiercode'],$bdd);
 
                  $reqActions = $bdd->prepare('SELECT * FROM actions WHERE dossiercode = ?');
                  $reqActions->execute(array($donnees['dossiercode']));

                  $reqRessource = $bdd->prepare('SELECT * FROM ressource WHERE dossiercode = ?');
                  $reqRessource->execute(array($donnees['dossiercode']));
                  
                  echo '<tr class="gradeA">';
	             echo  '<td>'.$i.'</td>'; 
                 echo  '<td>'.$donnees['nom'].'</td>'; 
                echo  '<td>'.$donnees['NUM_DEVIS'].'</td>'; 
                 echo  '<td>'.$donnees['KILOMETRAGE'].'</td>'; 
                 echo  '<td>'.$client.'</td>';
                 echo  '<td>'.$vehicule.'</td>';
                 echo  '<td>'.$donnees['OBJET_OR'].'</td>'; 
                 echo  '<td>'.strftime('%d-%m-%Y',strtotime($donnees['datedebut'])).'</td>'; 
                 echo  '<td>'.strftime('%d-%m-%Y',strtotime($donnees['datefin'])).'</td>'; 
                 echo  '<td style="background-color:#ffffff;"><table style="display: table;border-collapse: separate;border-spacing: 2px;border-color: gray;">';
                 while ($donneesAction = $reqActions->fetch())
                 {
				  echo '<tr style="background-color:#ffffff;">';
				  echo  '<td style="background-color:#ffffff;">'.$donneesAction['libelleaction'].'</td>';
				  echo  '<td style="background-color:#ffffff;">'.$donneesAction['resumer'].'</td>'; 
				  echo  '<td style="background-color:#ffffff;">'.$donneesAction['datedebut'].'</td>';	
				  echo  '<td style="background-color:#ffffff;">'.$donneesAction['idetat'].'</td>';
				  echo  '<td style="background-color:#ffffff;">'.$donneesAction['datefin'].'</td>';
				   echo '</tr>'; 
				 }
                 echo '</table></td>'; 
                  echo  '<td style="background-color:#ffffff;"><table style="display: table;border-collapse: separate;border-spacing: 2px;border-color: gray;">';
                 while ($donneesRessource = $reqRessource->fetch())
                 {
				  echo '<tr style="background-color:#ffffff;">';
				  echo  '<td style="background-color:#ffffff;">'.$donneesRessource['nature'].'</td>';
				  echo  '<td style="background-color:#ffffff;">'.$donneesRessource['libelle'].'</td>'; 
				  echo  '<td style="background-color:#ffffff;">'.$donneesRessource['motif'].'</td>'; 
				  echo  '<td style="background-color:#ffffff;">'.$donneesRessource['datedebut'].'</td>';	
				  echo  '<td style="background-color:#ffffff;">'.$donneesRessource['resetat'].'</td>';
				  echo  '<td style="background-color:#ffffff;">'.$donneesRessource['datefin'].'</td>';
				   echo '</tr>'; 
				 }
                 echo '</table></td>'; 
                 
                 
                 echo '</tr>';
                $i++;
              }
                ?>
              </tbody>
            </table>
          </div>
        </div>
   
      </div>
    </div>
  </div>
</div>
   
   
   
<div class="row-fluid">
  <div id="footer" class="span12"> 2019 &copy;  <a href="#">CCBM TECHNOLOGIES ET SOLUTIONS</a> </div>
</div>
<script src="js/jquery.min.js"></script> 
<script src="js/jquery.ui.custom.js"></script> 
<script src="js/bootstrap.min.js"></script> 
<script src="js/jquery.uniform.js"></script> 
<script src="js/select2.min.js"></script> 
<script src="js/jquery.dataTables.min.js"></script> 
<script src="js/maruti.js"></script> 
<script src="js/maruti.tables.js"></script>
<script src="js/maruti.form_validation.js"></script>

</body>
</html>
